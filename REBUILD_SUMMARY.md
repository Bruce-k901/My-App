# ğŸ—ï¸ TASKS MODULE REBUILD - COMPLETE

## âœ… What's Been Done

### 1. Database Migrations Created âœ…

- **`supabase/migrations/20250221000001_archive_and_clean_tasks.sql`**
  - Archives all templates to `task_templates_archive`
  - Deletes all `checklist_tasks` instances
  - Deletes custom templates (library templates kept)
- **`supabase/migrations/20250221000002_create_site_checklists_table.sql`**
  - Creates `site_checklists` table for task configurations
  - Includes RLS policies
  - Auto-sets site_id and company_id via trigger
- **`supabase/migrations/20250221000003_update_checklist_tasks_table.sql`**
  - Adds `site_checklist_id` column to `checklist_tasks`
  - Updates RLS policies

### 2. Edge Function Updated âœ…

- **`supabase/functions/generate-daily-tasks/index.ts`**
  - Now reads from `site_checklists` (configurations)
  - Creates task instances in `checklist_tasks`
  - Supports daily, weekly, monthly, PPM, and callout tasks

### 3. Pages Renamed & Updated âœ…

- **`/dashboard/my_templates`** (was `/dashboard/tasks/templates`)
  - Shows user-created custom templates
  - Queries `task_templates WHERE is_template_library = false`
- **`/dashboard/my_tasks`** (was `/dashboard/tasks/active`)
  - Shows task configurations from `site_checklists`
  - These are recurring task configurations, not instances
- **`/dashboard/todays_tasks`** (was `/dashboard/checklists`)
  - Shows today's task instances from `checklist_tasks`
  - Generated by Edge Function from configurations

### 4. Navigation Updated âœ…

- **Sidebar**: Updated all links to new routes
- **Header**: Updated "Today's Tasks" link
- **TaskFromTemplateModal**: Redirects to `/dashboard/my_tasks`

### 5. TaskFromTemplateModal Updated âœ…

- Now saves to `site_checklists` instead of `checklist_tasks`
- Builds `daypart_times` object for multi-time tasks
- Stores `equipment_config` for temperature checks
- Supports editing existing configurations

---

## ğŸš€ NEXT STEPS - DEPLOYMENT

### Step 1: Run SQL Migrations (5 minutes)

Run these in Supabase SQL Editor in order:

1. **Archive & Clean**:

   ```sql
   -- Run: supabase/migrations/20250221000001_archive_and_clean_tasks.sql
   ```

2. **Create site_checklists table**:

   ```sql
   -- Run: supabase/migrations/20250221000002_create_site_checklists_table.sql
   ```

3. **Update checklist_tasks**:
   ```sql
   -- Run: supabase/migrations/20250221000003_update_checklist_tasks_table.sql
   ```

### Step 2: Deploy Edge Function (2 minutes)

```powershell
supabase functions deploy generate-daily-tasks
```

### Step 3: Test the Workflow

1. **Create a Configuration**:
   - Go to `/dashboard/tasks/compliance`
   - Click "Fridge/Freezer Temperature Check"
   - Configure times: 07:00, 12:00, 17:00
   - Select equipment
   - Save
   - **Should appear in** `/dashboard/my_tasks`

2. **Run Edge Function**:

   ```powershell
   .\test-edge-function.ps1
   ```

   - **Should create** 3 tasks (one per time)

3. **Verify Today's Tasks**:
   - Go to `/dashboard/todays_tasks`
   - **Should see** 3 fridge temperature check tasks

---

## ğŸ“‹ NEW ARCHITECTURE

```
Compliance Templates (/dashboard/tasks/compliance)
  â†“ (User clicks "Use Template")
My Templates (/dashboard/my_templates) - Custom templates
  â†“ (User clicks template)
TaskFromTemplateModal
  â†“ (Saves configuration)
site_checklists (My Tasks page)
  â†“ (Edge Function reads)
checklist_tasks (Today's Tasks page)
```

---

## ğŸ¯ KEY CHANGES

### Before:

- Creating a task â†’ Saved directly to `checklist_tasks`
- Active Tasks page â†’ Showed all tasks
- Confusing: templates vs tasks vs instances

### After:

- Creating a task â†’ Saves configuration to `site_checklists`
- My Tasks page â†’ Shows configurations (recurring task setups)
- Today's Tasks page â†’ Shows generated instances (what to do today)
- Clear separation: configurations vs instances

---

## âš ï¸ IMPORTANT NOTES

1. **Old tasks will be deleted** when you run the archive migration
2. **Custom templates will be archived** (can be restored from `task_templates_archive`)
3. **Library templates are preserved** (SFBB/H&S templates)
4. **After migration, you'll need to recreate configurations** from templates

---

## ğŸ“ ROUTE SUMMARY

| Old Route                     | New Route                     | Purpose                |
| ----------------------------- | ----------------------------- | ---------------------- |
| `/dashboard/tasks/templates`  | `/dashboard/my_templates`     | Custom templates       |
| `/dashboard/tasks/active`     | `/dashboard/my_tasks`         | Task configurations    |
| `/dashboard/checklists`       | `/dashboard/todays_tasks`     | Today's task instances |
| `/dashboard/tasks/compliance` | `/dashboard/tasks/compliance` | (No change)            |

---

## âœ… READY TO DEPLOY!

All code changes are complete. Run the SQL migrations and deploy the Edge Function to complete the rebuild.
